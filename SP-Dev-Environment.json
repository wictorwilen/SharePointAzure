{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "ServiceName": {
            "type": "string"
        },
        "resourceLocation": {
            "type": "string"
        },
        "DomainAdminAccount": { "type": "string" },
        "DomainAdminAccountPassword": { "type": "securestring" },
        "DomainNameFQDN": { "type": "string" },
        "DomainName": { "type": "string" },
        "SQLServiceAccount": { "type": "string" },
        "SQLServiceAccountPassword": { "type": "securestring" },
        "FarmAccount": { "type": "string" },
        "FarmAccountPassword": { "type": "securestring" },
        "InstallAccount": { "type": "string" },
        "InstallAccountPassword": { "type": "securestring" },
        "WebPoolManagedAccount": { "type": "string" },
        "WebPoolManagedAccountPassword": { "type": "securestring" },
        "ServicePoolManagedAccount": { "type": "string" },
        "ServicePoolManagedAccountPassword": { "type": "securestring" },
        "FarmPassPhrase": { "type": "string" },
        "SharePointProductKey": { "type": "string" },
        "WebAppUrl": { "type": "string" },
        "TeamSiteUrl": { "type": "string" },
        "MySiteHostUrl": { "type": "string" },
        "DevSiteUrl": { "type": "string" }

    },
    "variables": {
        "DCDomainName": "[concat(parameters('ServiceName'),'-DC')]",
        "SPDomainName": "[concat(parameters('ServiceName'),'-SP')]",
        "StorageType": "Standard_LRS",
        "DCHardware": "Basic_A1",
        "SPHardware": "Basic_A4",
        "StorageName": "[concat(parameters('ServiceName'),'storage')]",
        "VNetName": "[concat(parameters('ServiceName'),'VNet')]",
        "DC1Name": "[concat(parameters('ServiceName'),'-dc1')]",
        "SP1Name": "[concat(parameters('ServiceName'),'-sp1')]",
        "DC1Disk1Name": "[concat(parameters('ServiceName'),'-DC1-os')]",
        "DC1Disk2Name": "[concat(parameters('ServiceName'),'-DC1-data')]",
        "SP1Disk1Name": "[concat(parameters('ServiceName'),'-SP1-os')]",
        "SP1Disk2Name": "[concat(parameters('ServiceName'),'-SP1-data1')]",
        "SP1Disk3Name": "[concat(parameters('ServiceName'),'-SP1-data2')]",
        "SP1Disk4Name": "[concat(parameters('ServiceName'),'-SP1-data3')]",
        "DCImage": "a699494373c04fc0bc8f2bb1389d6106__Windows-Server-2012-R2-201502.01-en.us-127GB.vhd",
        "SPImage": "03f55de797f546a1b29d1b8d66be687a__Visual-Studio-2013-Ultimate-Update4-AzureSDK-2.5-WS2012-201502.23"

    },
    "resources": [
        {
            "type": "Microsoft.ClassicStorage/StorageAccounts",
            "name": "[variables('StorageName')]",
            "apiVersion": "2014-06-01",
            "location": "[parameters('resourceLocation')]",
            "properties": {
                "accountType": "[variables('StorageType')]"
            }
        },
        {
            "type": "Microsoft.ClassicNetwork/virtualNetworks",
            "name": "[variables('VNetName')]",
            "apiVersion": "2014-06-01",
            "location": "[parameters('resourceLocation')]",
            "properties": {
                "addressSpace": {
                    "addressPrefixes": [
                        "10.1.0.0/26"
                    ]
                },
                "dhcpOptions": {
                    /* Using a public DNS (Google public = 8.8.8.8.) so that the DSC extensions can download its stuff*/
                    "dnsServers": [ "10.1.0.20", "8.8.8.8" ]
                },
                "subnets": [
                    {
                        "name": "Subnet-SP",
                        "addressPrefix": "10.1.0.0/28"
                    },
                    {
                        "name": "Subnet-DC",
                        "addressPrefix": "10.1.0.16/28"
                    }
                ]
            }
        },
        {
            "type": "Microsoft.classicCompute/domainNames",
            "name": "[variables('DCDomainName')]",
            "apiVersion": "2014-06-01",
            "location": "[parameters('resourceLocation')]",
            "properties": {
                "label": "[variables('DCDomainName')]"
            }
        },
        {
            "type": "Microsoft.classicCompute/domainNames",
            "name": "[variables('SPDomainName')]",
            "apiVersion": "2014-06-01",
            "location": "[parameters('resourceLocation')]",
            "properties": {
                "label": "[variables('SPDomainName')]"
            }
        },
        {
            "type": "Microsoft.ClassicCompute/virtualMachines",
            "name": "[variables('DC1Name')]",
            "apiVersion": "2014-06-01",
            "location": "[parameters('resourceLocation')]",
            "properties": {
                "domainName": {
                    "id": "[concat(resourceGroup().id, '/providers/Microsoft.classicCompute/domainNames/', variables('DCDomainName'))]"
                },
                "networkProfile": {
                    "virtualNetwork": {
                        "staticIpAddress": "10.1.0.20",
                        "id": "[resourceId('Microsoft.ClassicNetwork/virtualNetworks', variables('VNetName'))]",
                        "subnetNames": [
                            "Subnet-DC"
                        ]
                    },
                    "inputEndpoints": [
                        {
                            "enableDirectServerReturn": "False",
                            "endpointName": "Remote Desktop",
                            "privatePort": 3389,
                            "protocol": "tcp"
                        },
                        {
                            "enableDirectServerReturn": "False",
                            "endpointName": "Powershell",
                            "privatePort": 5986,
                            "protocol": "tcp"
                        }
                    ]
                },
                "hardwareProfile": {
                    "size": "[variables('DCHardware')]",
                    "platformGuestAgent": "true",
                    "availabilitySet": "[concat(parameters('ServiceName'),'-DC-AvailSet')]"
                },
                "operatingSystemProfile": {
                    "computerName": "[variables('DC1Name')]",
                    "adminUserName": "[parameters('DomainAdminAccount')]",
                    "adminPassword": "[parameters('DomainAdminAccountPassword')]",
                    "windowsOperatingSystemProfile": {
                        "winRMListeners": [
                            {
                                "protocol": "Https"
                            }
                        ]
                    }
                },
                "storageProfile": {
                    "operatingSystemDisk": {
                        "diskName": "[variables('DC1Disk1Name')]",
                        "vhdUri": "[concat(reference(concat('Microsoft.ClassicStorage/storageAccounts/', variables('StorageName'))).endpoints[0], 'vhds/', parameters('ServiceName'), variables('DC1Disk1Name'),'.vhd')]",
                        "caching": "ReadWrite",
                        "sourceImageName": "[variables('DCImage')]"
                    },
                    "dataDisks": [
                        {
                            "diskName": "[variables('DC1Disk2Name')]",
                            "caching": "None",
                            "diskSize": "120",
                            "lun": "0",
                            "vhdUri": "[concat(reference(concat('Microsoft.ClassicStorage/storageAccounts/', variables('StorageName'))).endpoints[0], 'vhds/', parameters('ServiceName'), variables('DC1Disk2Name'),'.vhd')]"
                        }
                    ]

                },
                "extensions": [
                    {
                        "extension": "BGInfo",
                        "publisher": "Microsoft.Compute",
                        "version": "1.*"
                    },
                    {
                        "extension": "DSC",
                        "publisher": "Microsoft.Powershell",
                        "version": "1.*",
                        "parameters": {
                            "public": {
                                "ConfigurationFunction": "CreateADPrimaryDomainController.ps1\\ADDSForest",
                                "ModulesUrl": "https://wwazprst.blob.core.windows.net/scripts/CreateADPrimaryDomainController.ps1.zip",
                                "Properties": {
                                    "DomainName": "[parameters('DomainNameFQDN')]",
                                    "DomainNetBiosName": "[parameters('DomainName')]",
                                    "DomainAdminAccount": {
                                        "UserName": "[parameters('DomainAdminAccount')]",
                                        "Password": "PrivateSettingsRef:DomainAdminAccountPassword"
                                    },
                                    "SQLServiceAccount": {
                                        "UserName": "[parameters('SQLServiceAccount')]",
                                        "Password": "PrivateSettingsRef:SQLServiceAccountPassword"
                                    },
                                    "FarmAccount": {
                                        "UserName": "[parameters('FarmAccount')]",
                                        "Password": "PrivateSettingsRef:FarmAccountPassword"
                                    },
                                    "InstallAccount": {
                                        "UserName": "[parameters('InstallAccount')]",
                                        "Password": "PrivateSettingsRef:InstallAccountPassword"
                                    },
                                    "WebPoolManagedAccount": {
                                        "UserName": "[parameters('WebPoolManagedAccount')]",
                                        "Password": "PrivateSettingsRef:WebPoolManagedAccountPassword"
                                    },
                                    "ServicePoolManagedAccount": {
                                        "UserName": "[parameters('ServicePoolManagedAccount')]",
                                        "Password": "PrivateSettingsRef:ServicePoolManagedAccountPassword"
                                    }

                                }
                            },
                            "private": {
                                "Items": {
                                    "DomainAdminAccountPassword": "[parameters('DomainAdminAccountPassword')]",
                                    "SQLServiceAccountPassword": "[parameters('SQLServiceAccountPassword')]",
                                    "FarmAccountPassword": "[parameters('FarmAccountPassword')]",
                                    "InstallAccountPassword": "[parameters('InstallAccountPassword')]",
                                    "WebPoolManagedAccountPassword": "[parameters('WebPoolManagedAccountPassword')]",
                                    "ServicePoolManagedAccountPassword": "[parameters('ServicePoolManagedAccountPassword')]"
                                }
                            }
                        }
                    }
                ]
            },
            "dependsOn": [
                "[concat('Microsoft.classicCompute/domainNames/', variables('DCDomainName'))]",
                "[concat('Microsoft.ClassicNetwork/virtualNetworks/', variables('VNetName'))]",
                "[concat('Microsoft.ClassicStorage/storageAccounts/', variables('StorageName'))]"

            ]
        },
        {
            "type": "Microsoft.ClassicCompute/virtualMachines",
            "name": "[variables('SP1Name')]",
            "apiVersion": "2014-06-01",
            "location": "[parameters('resourceLocation')]",
            "properties": {
                "domainName": {
                    "id": "[concat(resourceGroup().id, '/providers/Microsoft.classicCompute/domainNames/', variables('SPDomainName'))]"
                },
                "networkProfile": {
                    "virtualNetwork": {
                        "id": "[resourceId('Microsoft.ClassicNetwork/virtualNetworks', variables('VNetName'))]",
                        "subnetNames": [
                            "Subnet-SP"
                        ]
                    },
                    "inputEndpoints": [
                        {
                            "enableDirectServerReturn": "False",
                            "endpointName": "Remote Desktop",
                            "privatePort": 3389,
                            "protocol": "tcp"
                        },
                        {
                            "enableDirectServerReturn": "False",
                            "endpointName": "Powershell",
                            "privatePort": 5986,
                            "protocol": "tcp"
                        }
                    ]
                },
                "hardwareProfile": {
                    "size": "[variables('SPHardware')]",
                    "platformGuestAgent": "true",
                    "availabilitySet": "[concat(parameters('ServiceName'),'AvailSet')]"
                },
                "operatingSystemProfile": {
                    "computerName": "[variables('SP1Name')]",
                    "adminUserName": "[parameters('DomainAdminAccount')]",
                    "adminPassword": "[parameters('DomainAdminAccountPassword')]",
                    "windowsOperatingSystemProfile": {
                        "winRMListeners": [
                            {
                                "protocol": "Https"
                            }
                        ]

                    }
                },
                "storageProfile": {
                    "operatingSystemDisk": {
                        "diskName": "[variables('SP1Disk1Name')]",
                        "vhdUri": "[concat(reference(concat('Microsoft.ClassicStorage/storageAccounts/', variables('StorageName'))).endpoints[0], 'vhds/', parameters('ServiceName'), variables('SP1Disk1Name'),'.vhd')]",
                        "caching": "ReadWrite",
                        "sourceImageName": "[variables('SPImage')]"
                    },
                    "dataDisks": [
                        {
                            "diskName": "[variables('SP1Disk2Name')]",
                            "caching": "None",
                            "diskSize": "1023",
                            "lun": "0",
                            "vhdUri": "[concat(reference(concat('Microsoft.ClassicStorage/storageAccounts/', variables('StorageName'))).endpoints[0], 'vhds/', parameters('ServiceName'), variables('SP1Disk2Name'),'.vhd')]",
                        },
                        {
                            "diskName": "[variables('SP1Disk3Name')]",
                            "caching": "None",
                            "diskSize": "1023",
                            "lun": "1",
                            "vhdUri": "[concat(reference(concat('Microsoft.ClassicStorage/storageAccounts/', variables('StorageName'))).endpoints[0], 'vhds/', parameters('ServiceName'), variables('SP1Disk3Name'),'.vhd')]",
                        },
                        {
                            "diskName": "[variables('SP1Disk3Name')]",
                            "caching": "None",
                            "diskSize": "1023",
                            "lun": "2",
                            "vhdUri": "[concat(reference(concat('Microsoft.ClassicStorage/storageAccounts/', variables('StorageName'))).endpoints[0], 'vhds/', parameters('ServiceName'), variables('SP1Disk4Name'),'.vhd')]",
                        }
                    ]

                },
                "extensions": [
                    {
                        "extension": "BGInfo",
                        "publisher": "Microsoft.Compute",
                        "version": "1.*"
                    },
                    {
                        "extension": "DSC",
                        "publisher": "Microsoft.Powershell",
                        "version": "1.*",
                        "parameters": {
                            "public": {
                                "ConfigurationFunction": "CreateSingleMSDNSPServer.ps1\\SingleMSDNServer",
                                "ModulesUrl": "https://wwazprst.blob.core.windows.net/scripts/CreateSingleMSDNSPServer.ps1.zip",
                                "Properties": {
                                    "DomainNameFQDN": "[parameters('DomainNameFQDN')]",
                                    "DomainName": "[parameters('DomainName')]",
                                    "ProductKey": "[parameters('SharePointProductKey')]",
                                    "FarmPassPhrase": "[parameters('FarmPassPhrase')]",
                                    "WebAppUrl": "[parameters('WebAppUrl')]",
                                    "TeamSiteUrl": "[parameters('TeamSiteUrl')]",
                                    "DevSiteUrl": "[parameters('DevSiteUrl')]",
                                    "MySiteHostUrl": "[parameters('MySiteHostUrl')]",
                                    "DomainAdminAccount": {
                                        "UserName": "[parameters('DomainAdminAccount')]",
                                        "Password": "PrivateSettingsRef:DomainAdminAccountPassword"
                                    },
                                    "SQLServiceAccount": {
                                        "UserName": "[parameters('SQLServiceAccount')]",
                                        "Password": "PrivateSettingsRef:SQLServiceAccountPassword"
                                    },
                                    "FarmAccount": {
                                        "UserName": "[parameters('FarmAccount')]",
                                        "Password": "PrivateSettingsRef:FarmAccountPassword"
                                    },
                                    "InstallAccount": {
                                        "UserName": "[parameters('InstallAccount')]",
                                        "Password": "PrivateSettingsRef:InstallAccountPassword"
                                    },
                                    "WebPoolManagedAccount": {
                                        "UserName": "[parameters('WebPoolManagedAccount')]",
                                        "Password": "PrivateSettingsRef:WebPoolManagedAccountPassword"
                                    },
                                    "ServicePoolManagedAccount": {
                                        "UserName": "[parameters('ServicePoolManagedAccount')]",
                                        "Password": "PrivateSettingsRef:ServicePoolManagedAccountPassword"
                                    }

                                }
                            },
                            "private": {
                                "Items": {
                                    "DomainAdminAccountPassword": "[parameters('DomainAdminAccountPassword')]",
                                    "SQLServiceAccountPassword": "[parameters('SQLServiceAccountPassword')]",
                                    "FarmAccountPassword": "[parameters('FarmAccountPassword')]",
                                    "InstallAccountPassword": "[parameters('InstallAccountPassword')]",
                                    "WebPoolManagedAccountPassword": "[parameters('WebPoolManagedAccountPassword')]",
                                    "ServicePoolManagedAccountPassword": "[parameters('ServicePoolManagedAccountPassword')]"
                                }
                            }
                        }
                    }
                ]
            },
            "dependsOn": [
                "[concat('Microsoft.classicCompute/domainNames/', variables('SPDomainName'))]",
                "[concat('Microsoft.ClassicNetwork/virtualNetworks/', variables('VNetName'))]",
                "[concat('Microsoft.ClassicStorage/storageAccounts/', variables('StorageName'))]" ,
                "[concat('Microsoft.ClassicCompute/virtualMachines/', variables('DC1Name'))]"

            ]
        }
    ]
}